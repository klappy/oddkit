üî¨ Adversarial tests for canon/weighted-relevance-and-arbitration.md
======================================================================

üìÅ Creating fixture repo at /var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.jNbB3oXf1n

==========================================
TEST A: Workaround must not outrank promoted
==========================================

{
  "success": true,
  "localIndexPath": "/var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.jNbB3oXf1n/.oddkit/index.json",
  "baselineIndexPath": null,
  "stats": {
    "total": 4,
    "local": 4,
    "baseline": 0,
    "byAuthority": {
      "governing": 1,
      "operational": 3,
      "non-governing": 0
    }
  },
  "baseline": {
    "available": false,
    "url": "https://github.com/klappy/klappy.dev.git",
    "source": "default",
    "ref": "invalid-ref-to-disable",
    "refSource": "environment",
    "commit": null,
    "error": "Command failed: git clone --branch invalid-ref-to-disable --single-branch https://github.com/klappy/klappy.dev.git /Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable\nCloning into '/Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable'...\nfatal: Remote branch invalid-ref-to-disable not found in upstream origin\n"
  }
}
Query: 'What is the authentication policy?'

‚úÖ Promoted doc (canon/auth-policy.md) is in evidence
üìã Vetoed items: "vetoed": []
‚úÖ Intent-gated precedence rule active
‚úÖ First evidence citation is from promoted doc

==========================================
TEST B: Low confidence must trigger defer/escalate
==========================================

Query: 'What is the API guide?'

üìä Confidence: 0.46
‚úÖ Advisory flag is true (low confidence)
üìã Arbitration outcome: "outcome": "escalate"
‚úÖ Outcome is defer or escalate (correct for low confidence)
‚úÖ Low confidence advisory rule fired

==========================================
TEST C: Local+baseline duplicates must prefer local with warning
==========================================

Query: 'What is the definition of done?'

üìã Arbitration outcome: "outcome": "prefer"
‚úÖ Outcome is prefer (not defer due to duplicates)
‚ö†Ô∏è No duplicates collapsed (may be OK if URI dedup worked)
üìã Collapsed groups: "collapsed_groups": 129
‚úÖ First evidence is from local origin (dedup prefers local)

==========================================
TEST D: Path collision across repos must not collapse (different content)
==========================================

Created fixture with docs/README.md (different content, no URI)
{
  "success": true,
  "localIndexPath": "/var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.NJzc5Cw6EN/.oddkit/index.json",
  "baselineIndexPath": null,
  "stats": {
    "total": 1,
    "local": 1,
    "baseline": 0,
    "byAuthority": {
      "governing": 0,
      "operational": 1,
      "non-governing": 0
    }
  },
  "baseline": {
    "available": false,
    "url": "https://github.com/klappy/klappy.dev.git",
    "source": "default",
    "ref": "invalid-ref-to-disable",
    "refSource": "environment",
    "commit": null,
    "error": "Command failed: git clone --branch invalid-ref-to-disable --single-branch https://github.com/klappy/klappy.dev.git /Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable\nCloning into '/Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable'...\nfatal: Remote branch invalid-ref-to-disable not found in upstream origin\n"
  }
}
‚ö†Ô∏è Could not verify identity type in output

==========================================
TEST E: URI collision with different content must warn
==========================================

Created fixture with URI collision: docs/v1/policy.md and docs/v2/policy.md
{
  "success": true,
  "localIndexPath": "/var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.shsagKXPU7/.oddkit/index.json",
  "baselineIndexPath": null,
  "stats": {
    "total": 2,
    "local": 2,
    "baseline": 0,
    "byAuthority": {
      "governing": 0,
      "operational": 2,
      "non-governing": 0
    }
  },
  "baseline": {
    "available": false,
    "url": "https://github.com/klappy/klappy.dev.git",
    "source": "default",
    "ref": "invalid-ref-to-disable",
    "refSource": "environment",
    "commit": null,
    "error": "Command failed: git clone --branch invalid-ref-to-disable --single-branch https://github.com/klappy/klappy.dev.git /Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable\nCloning into '/Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable'...\nfatal: Remote branch invalid-ref-to-disable not found in upstream origin\n"
  }
}
‚úÖ URI_COLLISION warning detected (same origin, different content)
‚úÖ URI_COLLISION_DETECTED rule fired

==========================================
TEST F: URI collision (same origin) must escalate
==========================================

Created fixture with URI collision: canon/auth-rules.md and docs/auth-rules.md (same URI, different content)
{
  "success": true,
  "localIndexPath": "/var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.BjTwROvbTy/.oddkit/index.json",
  "baselineIndexPath": null,
  "stats": {
    "total": 2,
    "local": 2,
    "baseline": 0,
    "byAuthority": {
      "governing": 1,
      "operational": 1,
      "non-governing": 0
    }
  },
  "baseline": {
    "available": false,
    "url": "https://github.com/klappy/klappy.dev.git",
    "source": "default",
    "ref": "invalid-ref-to-disable",
    "refSource": "environment",
    "commit": null,
    "error": "Command failed: git clone --branch invalid-ref-to-disable --single-branch https://github.com/klappy/klappy.dev.git /Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable\nCloning into '/Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable'...\nfatal: Remote branch invalid-ref-to-disable not found in upstream origin\n"
  }
}
‚úÖ URI_COLLISION warning detected
üìã Arbitration outcome: "outcome": "escalate"
‚úÖ Outcome is escalate (correct for URI collision)
‚úÖ URI_COLLISION_DETECTED rule fired

==========================================
TEST G: Code block must not trigger NORMATIVE_DRIFT
==========================================

Creating baseline with code block containing MUST NOT...
{
  "success": true,
  "localIndexPath": "/var/folders/xx/bcq5t4w952zgfglf69dwsjk00000gn/T/tmp.KZNTQOYDYK/.oddkit/index.json",
  "baselineIndexPath": null,
  "stats": {
    "total": 2,
    "local": 2,
    "baseline": 0,
    "byAuthority": {
      "governing": 0,
      "operational": 2,
      "non-governing": 0
    }
  },
  "baseline": {
    "available": false,
    "url": "https://github.com/klappy/klappy.dev.git",
    "source": "default",
    "ref": "invalid-ref-to-disable",
    "refSource": "environment",
    "commit": null,
    "error": "Command failed: git clone --branch invalid-ref-to-disable --single-branch https://github.com/klappy/klappy.dev.git /Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable\nCloning into '/Users/chrisklapp/.oddkit/cache/klappy.dev/invalid-ref-to-disable'...\nfatal: Remote branch invalid-ref-to-disable not found in upstream origin\n"
  }
}
‚úÖ NORMATIVE_DRIFT_DETECTED did NOT fire (code blocks correctly stripped)
‚úÖ NEW_NORMATIVE_PROHIBITION did NOT fire (code blocks correctly stripped)

==========================================
SUMMARY
==========================================

‚úÖ Test A: Workaround vs Promoted - PASSED
‚úÖ Test B: Low Confidence Handling - PASSED
‚úÖ Test C: Duplicate Handling - PASSED
‚úÖ Test D: Path+Hash Identity - PASSED
‚úÖ Test E: URI Collision Detection - PASSED
‚úÖ Test F: URI Collision Escalation - PASSED
‚úÖ Test G: Code Block Normative Stripping - PASSED

üéâ All adversarial tests passed!
Exit: 0
