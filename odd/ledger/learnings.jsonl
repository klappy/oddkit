{"id":"learn-20260129-0001","timestamp":"2026-01-29T14:30:00Z","summary":"Freshness checks must compare against oddkit canon_target, not arbitrary versions, to avoid wasted updates","trigger":"policy","impact":"Derived prompts that update to intermediate versions create churn and confusion. Canon-target-first ensures updates only happen to the authoritative commit.","confidence":0.9,"sources":["klappy://canon/agents/odd-epistemic-guide","oddkit_policy_version"],"evidence":[{"type":"artifact","ref":"~/.cursor/agents/odd-epistemic-guide.md - Freshness Check section"}],"candidate_targets":["klappy://canon/agents/odd-epistemic-guide","klappy://canon/agents/odd-scribe"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260129-0002","timestamp":"2026-01-29T18:19:59Z","summary":"Comprehensive ODD agent documentation exists but was stale and lacked discoverability—users had no way to find subagents or setup instructions","trigger":"friction","impact":"Users cannot discover or configure ODD subagents (Epistemic Guide, Scribe) without explicit guidance, blocking adoption of core ODD capabilities","confidence":0.85,"sources":["docs/getting-started/agents.md","docs/getting-started/ledger.md","docs/getting-started/odd-agents-and-mcp.md"],"evidence":[{"type":"artifact","ref":"docs/getting-started/agents.md - setup instructions"},{"type":"artifact","ref":"docs/getting-started/odd-agents-and-mcp.md - system overview"}],"candidate_targets":["klappy://canon/odd/getting-started"],"proposed_escalation":"candidate-doc"}
{"id":"learn-20260130-0001","timestamp":"2026-01-30T01:30:00Z","summary":"The missing piece was agent role boundaries, not new principles—the map existed, we needed agents that knew how to use it without stepping on each other","trigger":"friction","impact":"Repeated mid-conversation steering was required because agents had overlapping or undefined responsibilities. Explicit role separation eliminates this drift.","confidence":0.95,"sources":["session-conversation-2026-01-30","klappy://canon/agents/odd-map-navigator","klappy://canon/agents/odd-mode-selector"],"evidence":[{"type":"artifact","ref":"klappy://canon/agents/odd-map-navigator"},{"type":"artifact","ref":"klappy://canon/agents/odd-mode-selector"},{"type":"artifact","ref":"klappy://canon/agents/odd-instruction-sync"},{"type":"artifact","ref":"klappy://canon/agents/odd-implementation-guide"}],"candidate_targets":["klappy://canon/agents"],"proposed_escalation":"none"}
{"id":"learn-20260130-0002","timestamp":"2026-01-30T01:32:00Z","summary":"Mode selector is MCP action routing with confidence, not a posture taxonomy—it picks the next action and asks minimum questions if unclear","trigger":"policy","impact":"Clarifies that mode selection reuses epistemic modes and MCP actions rather than inventing new concepts. Prevents future drift toward posture doctrine.","confidence":0.9,"sources":["klappy://canon/epistemic-modes","klappy://canon/agents/odd-mode-selector"],"evidence":[{"type":"artifact","ref":"klappy://canon/agents/odd-mode-selector - Purpose section"}],"candidate_targets":["klappy://canon/agents/odd-mode-selector"],"proposed_escalation":"none"}
{"id":"learn-20260130-0003","timestamp":"2026-01-30T01:34:00Z","summary":"Baseline cache auto-refreshes on any oddkit call via ensureBaselineRepo git fetch/pull—agents naturally get updates when oddkit is invoked","trigger":"policy","impact":"Understanding this flow is critical for the natural agent update path: push to klappy.dev → any oddkit call refreshes cache → sync-agents sees new files.","confidence":0.95,"sources":["oddkit/src/baseline/ensureBaselineRepo.js"],"evidence":[{"type":"artifact","ref":"oddkit/src/baseline/ensureBaselineRepo.js - lines 161-178"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260130-0004","timestamp":"2026-01-30T01:42:00Z","summary":"Cursor rules are the right place for universal safety constraints that apply when no agent is active, an agent goes off-script, or the interaction is quick and no one invoked a role","trigger":"policy","impact":"Agent role docs steer when an agent is selected; Cursor rules apply to every session. Keeping Compass in Cursor rules ensures the two failure modes—unjustified certainty and answering canon from memory—are covered even when role docs are missing or ignored.","confidence":0.9,"sources":["session-conversation-2026-01-30","oddkit/.cursor/rules/oddkit-compass.mdc"],"evidence":[{"type":"artifact","ref":"oddkit/.cursor/rules/oddkit-compass.mdc"}],"candidate_targets":["oddkit://docs/MCP.md"],"proposed_escalation":"none"}
{"id":"learn-20260205-0001","timestamp":"2026-02-05T12:00:00Z","summary":"NEVER hand-roll parsers (markdown, HTML escape, etc.) inside JavaScript template literals—use established CDN libraries instead","trigger":"friction","impact":"Hand-rolled regex inside TypeScript template literals caused TWO fatal bugs: (1) \\n in code block regex became a literal newline causing JS SyntaxError, (2) \\* in bold/italic regex was silently eaten producing /* which JS parsed as block comment start. Both killed the entire chat UI script—no event listeners attached, submit button completely inert. Switching to marked@15 + DOMPurify@3 from CDN eliminated all regex-in-template-literal issues permanently.","confidence":1.0,"sources":["workers/src/chat-ui.ts","session-conversation-2026-02-05"],"evidence":[{"type":"commit","ref":"40e06a9 - Fix fatal JS parse error in chat UI code block regex"},{"type":"commit","ref":"f49f757 - Fix bold/italic regex escaping in template literal"},{"type":"commit","ref":"e52ba0f - Replace hand-rolled markdown with marked + DOMPurify from CDN"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260205-0002","timestamp":"2026-02-05T12:01:00Z","summary":"Cloudflare Worker secrets set via wrangler secret put can be wiped by deploys—use Cloudflare dashboard (Workers > Settings > Variables and Secrets > Encrypt) for persistent secrets in cloud/CI environments","trigger":"friction","impact":"OPENAI_API_KEY set via wrangler secret put was wiped on every deploy, causing repeated 'API key not configured' errors. The --var flag in deploy scripts requires local env vars which are unavailable in cloud environments (Claude Code on web). The only reliable path for secrets in cloud CI is the Cloudflare dashboard encrypt option.","confidence":0.95,"sources":["workers/wrangler.toml","session-conversation-2026-02-05"],"evidence":[{"type":"commit","ref":"64c8e26 - Revert --var OPENAI_API_KEY from deploy, use dashboard secret"},{"type":"artifact","ref":"workers/wrangler.toml - comment documenting dashboard secret path"}],"candidate_targets":["oddkit://docs/deployment"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260205-0003","timestamp":"2026-02-05T12:02:00Z","summary":"NEVER assume the user's deployment environment is local—they may be in a cloud environment where they cannot set env vars, access local files, or commit secrets to a public repo","trigger":"friction","impact":"Attempted to solve OPENAI_API_KEY persistence by injecting via --var from shell environment. User was in Claude Code on the web—a cloud environment with no persistent local env vars. This caused significant frustration. Always ask about the deployment environment before proposing env-var-based solutions.","confidence":1.0,"sources":["session-conversation-2026-02-05"],"evidence":[{"type":"artifact","ref":"workers/package.json - deploy script reverted to original"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260205-0004","timestamp":"2026-02-05T12:03:00Z","summary":"Use the EXACT model name the user specifies—do not substitute or 'correct' it based on assumptions about what models exist","trigger":"friction","impact":"User requested gpt-5.2-mini but implementation used o4-mini based on assumption about available OpenAI models. User caught this in GitHub review. The user knows what model they want; the agent's job is to implement what was asked, not second-guess model availability.","confidence":1.0,"sources":["workers/src/chat-api.ts","session-conversation-2026-02-05"],"evidence":[{"type":"artifact","ref":"workers/src/chat-api.ts - MODEL = 'gpt-5.2-mini'"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260205-0005","timestamp":"2026-02-05T12:04:00Z","summary":"Client-side error display must show actual server error messages, not guess based on HTTP status codes","trigger":"friction","impact":"Chat UI hardcoded error messages like 'API key not configured' for 500 status, instead of reading the actual error body from the server. This made debugging impossible—the real error was hidden. Always parse and display res.json().error or res.json().detail from the response body.","confidence":0.95,"sources":["workers/src/chat-ui.ts","session-conversation-2026-02-05"],"evidence":[{"type":"commit","ref":"3041529 - Show actual API error instead of guessing from status code"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260205-0006","timestamp":"2026-02-05T12:05:00Z","summary":"Security-first for chat APIs: filter client messages to user/assistant roles only, validate body schema, restrict markdown link URLs to http/https, sanitize HTML output with DOMPurify","trigger":"policy","impact":"Multiple XSS and injection vectors were found in GitHub review: (1) client could inject system messages, (2) markdown javascript: URLs enabled XSS, (3) unescaped quotes in HTML attributes. All fixed by: role filtering, custom marked renderer with URL scheme whitelist, DOMPurify sanitization with ADD_ATTR for target.","confidence":0.95,"sources":["workers/src/chat-api.ts","workers/src/chat-ui.ts","session-conversation-2026-02-05"],"evidence":[{"type":"commit","ref":"8907d9a - Fix newline loss, javascript: URL XSS, and system message injection"},{"type":"commit","ref":"738dd7f - Fix review bugs: body validation, dead variable, XSS in markdown"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260206-0001","timestamp":"2026-02-06T00:00:00Z","summary":"OpenAI mini model is gpt-5-mini NOT gpt-5.2-mini — always verify model IDs against live OpenAI docs, not training data","trigger":"friction","impact":"gpt-5.2-mini does not exist in the OpenAI API — returns model_not_found error. The mini variant is from the GPT-5 family (gpt-5-mini). GPT-5.2 exists as a flagship but has no mini variant. Previous learning learn-20260205-0004 said use exact user names, but the user's requested name was also wrong. Must verify against live docs.","confidence":1.0,"sources":["https://platform.openai.com/docs/models","session-conversation-2026-02-06"],"evidence":[{"type":"artifact","ref":"OpenAI API error: The model gpt-5.2-mini does not exist"},{"type":"commit","ref":"5edf5e7 - Fix model name: gpt-5.2-mini does not exist, use gpt-5-mini"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260206-0002","timestamp":"2026-02-06T01:00:00Z","summary":"NEVER use markdown bold/italic (** or *) when giving the user links or text to paste — it breaks URLs and copy-paste","trigger":"friction","impact":"User asked for a PR link multiple times. Each time the response included ** markdown formatting which corrupts URLs and text when pasted into GitHub or browsers. The user had to ask again WITHOUT formatting. Plain text only for anything the user needs to copy.","confidence":1.0,"sources":["session-conversation-2026-02-06"],"evidence":[{"type":"artifact","ref":"User feedback: WITHOUT ** it breaks the links!!!"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260206-0003","timestamp":"2026-02-06T02:00:00Z","summary":"wrangler deploy with [vars] section nukes ALL dashboard-set env vars not listed in [vars] — must add keep_vars = true to wrangler.toml","trigger":"friction","impact":"Every single deploy wiped the OPENAI_API_KEY because wrangler treats [vars] as the complete set of variables. Dashboard-set secrets not in [vars] get deleted. User had to re-add the key a dozen times. The fix is keep_vars = true in wrangler.toml which tells wrangler to preserve dashboard variables not in the toml. Previous learning learn-20260205-0002 was WRONG — it blamed wrangler secret put but the real cause was the [vars] section overriding everything on deploy.","confidence":1.0,"sources":["https://developers.cloudflare.com/workers/wrangler/configuration/","https://community.cloudflare.com/t/keep-vars-not-working-as-expected/831643","session-conversation-2026-02-06"],"evidence":[{"type":"commit","ref":"f35b405 - Add keep_vars = true to stop deploys from nuking dashboard secrets"},{"type":"artifact","ref":"workers/wrangler.toml - keep_vars = true on line 8"}],"candidate_targets":[],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260206-0004","timestamp":"2026-02-06T03:00:00Z","summary":"GPT-5 family models require max_completion_tokens, not max_tokens — always RTFM on API parameter names","trigger":"friction","impact":"GPT-5 models reject the deprecated max_tokens parameter with a 400 error. The correct parameter is max_completion_tokens which accounts for both reasoning tokens and visible output tokens. This applies to all GPT-5.x, o-series, and GPT-4o models. Only legacy models (GPT-3.5, older GPT-4) accept max_tokens. Should have checked the live API docs before using the parameter.","confidence":1.0,"sources":["https://platform.openai.com/docs/api-reference/chat","https://community.openai.com/t/why-was-max-tokens-changed-to-max-completion-tokens/938077","session-conversation-2026-02-06"],"evidence":[{"type":"artifact","ref":"OpenAI API error: Unsupported parameter max_tokens, use max_completion_tokens"},{"type":"commit","ref":"e1b11d6 - Fix OpenAI API param: GPT-5 requires max_completion_tokens not max_tokens"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260206-0005","timestamp":"2026-02-06T04:00:00Z","summary":"When fixing one API param, check ALL params against live docs — gpt-5-mini also rejects temperature!=1","trigger":"friction","impact":"Fixed max_tokens to max_completion_tokens but left temperature:0.7 which gpt-5-mini also rejects. When you find one unsupported param, check every param in the request against live docs. Don't fix one and leave the rest unchecked. GPT-5 mini only supports temperature=1 (default).","confidence":1.0,"sources":["https://platform.openai.com/docs/api-reference/chat","session-conversation-2026-02-06"],"evidence":[{"type":"artifact","ref":"OpenAI API error: temperature does not support 0.7 with this model"},{"type":"commit","ref":"d7a2b35 - Remove temperature param — gpt-5-mini only supports default (1)"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260206-0006","timestamp":"2026-02-06T05:00:00Z","summary":"Never blindly inject RAG context on every chat turn — use LLM-driven function calling so the model decides when and what to retrieve","trigger":"friction","impact":"Blind context injection (oddkit enrichment on every message) caused cascading confusion: each turn accumulated verbose documentation in conversation history, model re-answered prior questions, lost track of what it already covered, and collapsed by turn 3. Replacing with OpenAI function calling lets the LLM decide IF it needs docs (skip for follow-ups) and WHAT to query (focused query vs raw user text). Also requires: (1) trimming long assistant messages in history to prevent context bloat, (2) system prompt instruction to focus on latest message only.","confidence":1.0,"sources":["workers/src/chat-api.ts","session-conversation-2026-02-06"],"evidence":[{"type":"artifact","ref":"workers/src/chat-api.ts - replaced getOddkitContext with ODDKIT_TOOL function calling"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260207-0001","timestamp":"2026-02-07T00:00:00Z","summary":"MCP tool discoverability requires strict spec compliance: 202 (not 204) for notifications, 405 (not JSON) for GET without SSE, serverInfo must not contain protocolVersion, CORS must include Authorization","trigger":"friction","impact":"ChatGPT agent builder and other MCP clients failed to discover tools because: (1) notifications/initialized got 204 instead of spec-mandated 202, causing clients to bail before tools/list; (2) GET /mcp returned JSON info page instead of 405, confusing clients into thinking it was legacy HTTP+SSE transport; (3) serverInfo contained extra protocolVersion field violating Implementation schema, causing strict validation failures; (4) CORS missing Authorization header blocked ChatGPT from sending auth tokens. Fix: 204→202, GET→405, remove protocolVersion from serverInfo, add Authorization to CORS, add instructions field to InitializeResult.","confidence":0.95,"sources":["workers/src/index.ts","spec.modelcontextprotocol.io/specification/2025-03-26/basic/transports/","platform.openai.com/docs/mcp"],"evidence":[{"type":"artifact","ref":"workers/src/index.ts - notification handler, GET handler, serverInfo, corsHeaders"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260209-0001","timestamp":"2026-02-09T08:30:00Z","summary":"oddkit has TWO MCP servers: local stdio (src/mcp/server.js) and remote Cloudflare Worker (workers/src/index.ts) — new tools must be added to BOTH or they won't appear in Claude.ai","trigger":"friction","impact":"Added four new MCP tools (orient, challenge, gate, encode) only to the local stdio server. User immediately noticed they weren't visible in Claude.ai's MCP connector settings — because Claude.ai connects to the remote Worker endpoint, not the local server. Had to duplicate tool definitions, schemas, and routing in both servers. The Worker has its own lightweight orchestrate.ts with ZipBaselineFetcher (not the full Node.js librarian pipeline), so tool implementations must also be adapted for the Worker context (no filesystem, no git, only HTTP fetches).","confidence":1.0,"sources":["workers/src/index.ts","src/mcp/server.js","session-conversation-2026-02-09"],"evidence":[{"type":"artifact","ref":"workers/src/index.ts - TOOLS array and tools/call handler"},{"type":"artifact","ref":"src/mcp/server.js - ALL_TOOLS array and CallToolRequestSchema handler"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260207-0002","timestamp":"2026-02-07T06:00:00Z","summary":"OpenAI Agent Builder 424 has THREE root causes: (1) missing serverInfo.version when env var undefined, (2) POST must return SSE not JSON when client sends Accept: text/event-stream, (3) batch JSON-RPC arrays must be handled","trigger":"friction","impact":"After 3 PRs fixing MCP spec compliance, ChatGPT agent builder still returned 424 Failed Dependency. Root causes: (1) ODDKIT_VERSION env var was undefined in production — JSON.stringify silently drops undefined fields, so serverInfo had no version field, violating the MCP Implementation schema (name+version both required). Strict validation rejects this. (2) OpenAI sends Accept: application/json, text/event-stream and expects SSE responses for POST (text/event-stream Content-Type with event: message + data: lines). Server was only returning application/json. Multiple community reports confirm SSE is required. (3) MCP spec allows batch requests (JSON arrays of messages) but server only handled single messages — Array.isArray check was missing, causing method:undefined errors. Fix: default version fallback, SSE responses when Accept includes text/event-stream, batch request loop with per-message response collection.","confidence":0.9,"sources":["workers/src/index.ts","community.openai.com/t/mcp-server-passes-all-json-rpc-tests-but-agent-builder-fails-with-424","github.com/jlowin/fastmcp/issues/855","modelcontextprotocol.io/specification/2025-03-26/basic/transports"],"evidence":[{"type":"artifact","ref":"curl -v oddkit.klappy.dev/mcp — serverInfo:{name:oddkit} with NO version field"},{"type":"artifact","ref":"workers/src/index.ts — POST handler returned application/json, never text/event-stream"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"candidate-constraint"}
{"id":"learn-20260210-0001","timestamp":"2026-02-10T12:00:00Z","summary":"Tool consolidation requires two-layer surface: unified orchestrator (with state) + individual tools (stateless). Standardize on canon_url param across both servers.","trigger":"policy","impact":"The Node server (src/mcp/server.js) used repo_root/baseline params while the Worker (workers/src/index.ts) used canon_url. Having two parameter schemas for the same tools caused routing confusion. Consolidation to canon_url standardizes the public API. The broken librarian was replaced with BM25 search (~100 lines) that indexes tags, titles, paths, and content excerpts. Individual tools are thin wrappers calling the same handleUnifiedAction — one implementation, two access patterns.","confidence":0.9,"sources":["src/mcp/server.js","workers/src/index.ts","workers/src/orchestrate.ts"],"evidence":[{"type":"artifact","ref":"git log showing Node server created first with repo_root/baseline, Worker added later with canon_url"},{"type":"artifact","ref":"workers/src/bm25.ts — minimal BM25 implementation replacing broken librarian"}],"candidate_targets":["klappy://canon/constraints"],"proposed_escalation":"none"}
{"id":"learn-20260211-0001","timestamp":"2026-02-11T01:10:00Z","summary":"Production deployment uses prod branch with CF Git integration, main is staging via preview deploys, promote.sh gates on version match before fast-forward push","trigger":"architecture","impact":"Version drift between package.json, workers/package.json, and ODDKIT_VERSION env var caused serverInfo.version to be undefined in production (learn-20260207-0002). Fix: prod branch is sole production source (D0001), main gets automatic preview deploys for staging, scripts/promote.sh enforces version gate by checking staging /health before allowing fast-forward to prod. No GitHub Actions needed — CF dashboard handles all deploy triggers. Shared KV/R2 bindings are safe because they are idempotent cache layers.","confidence":0.95,"sources":["docs/decisions/D0001-prod-branch-is-production.md","workers/wrangler.toml","scripts/promote.sh"],"evidence":[{"type":"artifact","ref":"gh api repos/klappy/oddkit/branches/prod/protection — allow_force_pushes:false, allow_deletions:false"},{"type":"artifact","ref":"scripts/promote.sh — version gate + fast-forward push"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0002","timestamp":"2026-02-11T02:05:00Z","summary":"CF Workers preview deploys use wrangler versions upload NOT wrangler deploy --env preview — the --env flag creates a separate worker, versions upload creates a previewable version of the same worker","trigger":"friction","impact":"Non-production branch deploy command was cd workers && npx wrangler deploy --env preview which created a separate oddkit-preview worker instead of a versioned preview of the oddkit worker. Preview URLs (*-oddkit.klappy.workers.dev) are generated by CF versioned deployments system. Fix: change non-production deploy command to cd workers && npx wrangler versions upload. This uploads a version without promoting to active, and CF generates a preview URL per version ID. See https://developers.cloudflare.com/workers/ci-cd/builds/","confidence":0.95,"sources":["https://developers.cloudflare.com/workers/ci-cd/builds/","CF dashboard build configuration"],"evidence":[{"type":"artifact","ref":"curl to oddkit-preview.klappy.workers.dev returned NOT REACHABLE — separate worker never deployed"},{"type":"artifact","ref":"CF docs: wrangler versions upload saves as version without promoting to active deployment"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0003","timestamp":"2026-02-11T02:12:00Z","summary":"CF Workers Builds preview URL format is <branch-sanitized>-<worker-name>.workers.dev — branch name lowercased, slashes to dashes, predictable and scriptable","trigger":"friction","impact":"Wasted significant time guessing preview URL formats. Tried git commit hash prefixes (7ee17eb-oddkit.klappy.workers.dev — 404) before discovering the correct pattern is branch-name-based. CF sanitizes branch names: lowercase + replace / with -. So claude/fix-version-drift-deployment-RhDz9 becomes claude-fix-version-drift-deployment-rhdz9-oddkit.klappy.workers.dev. This is deterministic — scripts can compute the URL from branch name without checking any dashboard. Formula: echo $BRANCH | tr '[:upper:]' '[:lower:]' | tr '/' '-' then append -oddkit.klappy.workers.dev. Two-gate testing workflow depends on this: Gate 1 uses branch preview URL, Gate 2 uses main-oddkit.klappy.workers.dev.","confidence":1.0,"sources":["https://developers.cloudflare.com/workers/ci-cd/builds/","tests/cloudflare-production.test.sh 34/34 pass on live preview"],"evidence":[{"type":"artifact","ref":"curl https://claude-fix-version-drift-deployment-rhdz9-oddkit.klappy.workers.dev/health returned v0.13.0"},{"type":"artifact","ref":"curl https://7ee17eb-oddkit.klappy.workers.dev returned 404 — commit hash format does NOT work"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0004","timestamp":"2026-02-11T02:25:00Z","summary":"GitHub Actions CI is enforcement layer 2 per convention-requires-an-enforcer: local hooks can be skipped by cloud agents, CI cannot be skipped","trigger":"architecture","impact":"Local git hooks require npm install to configure and can be bypassed with --no-verify. Cloud agents (Cursor cloud, Claude Code cloud/CLI) may never run npm install. GitHub Actions runs on every push/PR regardless of surface. Workflow has two jobs: version-check (mirrors pre-commit hook, ~5s) and test-preview (polls CF preview URL then runs full 34-test suite, ~60s). Branch protection on main requires both checks, enforced for admins. No PR required — direct push allowed if checks pass, cloud agents naturally create PRs anyway. Canon citation: convention-requires-an-enforcer says enforcement is layered: oddkit (local), CI (shared), constraints (normative).","confidence":0.95,"sources":["klappy://docs/appendices/convention-requires-an-enforcer",".github/workflows/ci.yml","gh api repos/klappy/oddkit/branches/main/protection"],"evidence":[{"type":"artifact","ref":"gh run view 21890306462 — Version Sync: success, Test CF Preview: success"},{"type":"artifact","ref":"gh api branches/main/protection — required_status_checks: [Version Sync, Test CF Preview], enforce_admins: true"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0005","timestamp":"2026-02-11T03:30:00Z","summary":"Creed is now embedded in three surfaces (AGENTS.md, chat-api.ts SYSTEM_PROMPT, orient response) with CI freshness enforcement and canon contract for klappy.dev","trigger":"architecture","impact":"The creed (5 lines from canon/values/orientation.md ## The Creed section) is the identity posture for all oddkit-governed agents. It was not automatically available — Ask mode blocked tools, and no agent-facing file carried it. Fix: (1) AGENTS.md replaces CLAUDE.md with creed at top (works in Cursor, Claude Code, Codex, Copilot). (2) chat-api.ts SYSTEM_PROMPT prepends creed. (3) orient action reads creed from baseline and prepends to response. (4) readOnlyHint annotations ported to local MCP server for Ask mode compatibility. (5) CI freshness script (scripts/check-creed-freshness.js) verifies creed lines from canon appear verbatim in AGENTS.md and chat-api.ts. Canon contract for klappy.dev: orientation.md must keep ## The Creed heading, creed lines must be non-empty non-heading non-blockquote lines under that heading. Changing creed text in canon will cause oddkit CI to fail, signaling AGENTS.md and chat-api.ts need updating.","confidence":0.95,"sources":["klappy://canon/values/orientation","AGENTS.md","workers/src/chat-api.ts","src/tasks/orient.js","workers/src/orchestrate.ts","src/mcp/server.js","scripts/check-creed-freshness.js",".github/workflows/ci.yml"],"evidence":[{"type":"artifact","ref":"node scripts/check-creed-freshness.js — PASSED: Creed is fresh in all consumer files"},{"type":"artifact","ref":"npm test — All smoke tests passed"},{"type":"artifact","ref":"npx wrangler deploy --dry-run — Total Upload: 136.41 KiB, exit 0"},{"type":"artifact","ref":"node orient test — creed: 5 lines, status: ORIENTED"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0006","timestamp":"2026-02-11T03:45:00Z","summary":"Orchestrator tool must NOT carry readOnlyHint because it routes to both read-only and write actions -- Ask mode would bypass write restriction via orchestrator routing","trigger":"bug-fix","impact":"The unified oddkit tool (ODDKIT_TOOL) routes to 11 actions including invalidate_cache which is a write action. Marking the orchestrator readOnlyHint:true allowed Ask mode clients to call invalidate_cache by routing through the orchestrator instead of the individual tool. Fix: omit readOnlyHint from orchestrator entirely. Individual tools carry accurate annotations. Alternative considered: readOnlyHint:false on orchestrator, but that blocks ALL actions in Ask mode including read-only ones like search and get. Omitting the hint is the honest middle ground. Reversible: yes, annotation-only change.","confidence":0.95,"sources":["src/mcp/server.js","workers/src/index.ts"],"evidence":[{"type":"artifact","ref":"src/mcp/server.js lines 195-200: annotations block with comment explaining omission"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0007","timestamp":"2026-02-11T03:45:00Z","summary":"API fields that may be absent must use null not undefined because JSON.stringify omits undefined fields entirely -- creed fallback standardized to null across all server surfaces","trigger":"bug-fix","impact":"Local orient (src/tasks/orient.js) returned creed: null when unavailable. Worker orient (workers/src/orchestrate.ts) returned creed: undefined. JSON serialization difference: null produces a present field, undefined omits it entirely. Consumers checking for if (result.creed) work either way, but consumers checking hasOwnProperty or iterating fields see inconsistent schemas. Standardized on null because explicit-null is a deliberate signal (we looked, it was not there) vs undefined which is ambiguous (did we look? did it fail? was the field not implemented?). Reversible: yes.","confidence":0.95,"sources":["src/tasks/orient.js","workers/src/orchestrate.ts"],"evidence":[{"type":"artifact","ref":"workers/src/orchestrate.ts line 682: creed: creed || null"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260211-0008","timestamp":"2026-02-11T03:45:00Z","summary":"AGENTS.md replaces CLAUDE.md as universal agent context file -- Cursor does not follow symlinks for rule files, and AGENTS.md is natively supported by Cursor, Claude Code, Codex, and Copilot","trigger":"architecture","impact":"CLAUDE.md was Claude-specific naming. When using Cursor, Codex, or Copilot, the filename was misleading. Considered: symlink CLAUDE.md to AGENTS.md, but web search confirmed Cursor does NOT follow symlinks for rule files. Considered: generating AGENTS.md from fragments via pre-commit hook, but violated KISS -- the file changes rarely and CI freshness check catches drift. Decision: direct rename via git mv. Both Cursor and Claude Code natively read AGENTS.md. The creed is embedded at the top as the first content any agent sees. Constraint: if a tool drops AGENTS.md support, we would need to add back a tool-specific file. Reversible: yes, git mv back.","confidence":0.95,"sources":["AGENTS.md","klappy://canon/values/orientation"],"evidence":[{"type":"artifact","ref":"git status: RM CLAUDE.md -> AGENTS.md"},{"type":"web-search","ref":"Cursor symlink support search -- confirmed not supported for rule files"}],"candidate_targets":[],"proposed_escalation":"none"}
{"id":"learn-20260212-0001","timestamp":"2026-02-12T04:22:00Z","summary":"oddkit validate evidence matching cannot satisfy several required evidence labels (coverage report, reproduction steps, test case, artifact path), so fix/test completion claims may remain NEEDS_ARTIFACTS despite explicit logs","trigger":"friction","impact":"While validating a real cache invalidation bug fix, validate kept returning NEEDS_ARTIFACTS even after including command outputs and test summaries. In src/tasks/validate.js, matchEvidence only matches screenshot/video/log-output/link heuristics, but requirements for test/fix/general include labels it does not map (coverage report, reproduction steps, before/after evidence, test case, artifact path). This can block PASS for legitimate completion claims unless evidence wording is adjusted or matcher coverage is expanded.","confidence":0.9,"sources":["src/tasks/validate.js","session-conversation-2026-02-12"],"evidence":[{"type":"artifact","ref":"src/tasks/validate.js lines 24-31 and 130-151"},{"type":"artifact","ref":"oddkit validate output on 2026-02-12 showing NEEDS_ARTIFACTS with unmet coverage report/reproduction/test-case gaps"}],"candidate_targets":[],"proposed_escalation":"none"}
