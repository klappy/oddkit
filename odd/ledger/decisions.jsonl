{"id":"dec-20260129-0001","timestamp":"2026-01-29T14:30:00Z","title":"Canon-target-first freshness protocol","status":"accepted","decision":"Derived prompts must check oddkit_policy_version for the authoritative canon_target before proposing updates, and must only update to that target — never to intermediate versions","context":"Derived agent prompts can become stale. Without a protocol, prompts might update to arbitrary versions, creating drift and confusion. We needed a consistent freshness mechanism.","options_considered":[{"option":"Always use latest commit","pros":["Simple","Always fresh"],"cons":["Unstable — intermediate commits may be broken or incomplete","No human gate"]},{"option":"Pin forever, manual updates only","pros":["Stable","Human controlled"],"cons":["Prompts go stale silently","No mechanism to detect drift"]},{"option":"Canon-target-first (chosen)","pros":["Compares against authoritative target","Human controls canon_target promotion","Detects staleness without forcing updates"],"cons":["Requires oddkit tooling","Slightly more complex"]}],"rationale":["Prevents wasted updates to intermediate versions","Preserves human authority over what counts as canonical","Makes staleness visible without being naggy","Already exercised in odd-epistemic-guide"],"consequences":["Derived prompts include canon_pinned_commit in frontmatter","Freshness check runs once per session at first gating moment","Soft refresh is advisory, hard refresh requires human approval"],"evidence":[{"type":"artifact","ref":"~/.cursor/agents/odd-epistemic-guide.md"},{"type":"doc","ref":"klappy://canon/agents/odd-epistemic-guide"}],"links":["klappy://canon/agents/odd-epistemic-guide","klappy://canon/agents/odd-scribe"],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260129-0002","timestamp":"2026-01-29T14:35:00Z","title":"Orientation docs live in klappy.dev; oddkit contains pointers","status":"accepted","decision":"Canonical ODD orientation and agent role documentation lives in klappy.dev. The oddkit repo contains pointers and tool-specific docs, not duplicated canon.","context":"With two repos (klappy.dev for canon, oddkit for tooling), we needed clarity on where orientation material belongs. Duplication creates drift; unclear boundaries create confusion.","options_considered":[{"option":"All docs in oddkit","pros":["Single location","Simpler for tool users"],"cons":["Conflates tool docs with canonical truth","oddkit becomes bloated with non-tool content"]},{"option":"All docs in klappy.dev","pros":["Single source of truth","Clear authority"],"cons":["Tool users must navigate two repos","Getting started friction"]},{"option":"Canon in klappy.dev, pointers in oddkit (chosen)","pros":["Clear separation of concerns","Canon stays authoritative","oddkit stays focused on tooling","Pointers reduce friction without duplicating"],"cons":["Two repos to maintain","Must keep pointers fresh"]}],"rationale":["klappy.dev is already the canonical truth location","oddkit is a tool, not a doctrine","Pointers are cheaper to maintain than duplicates","Follows existing pattern with odd-epistemic-guide"],"consequences":["oddkit/docs/getting-started/ contains pointers to klappy.dev canon","Agent roles are defined in klappy.dev/canon/agents/","Derived prompts in ~/.cursor/agents/ cite klappy:// URIs as source"],"evidence":[{"type":"artifact","ref":"/Users/chrisklapp/oddkit/docs/getting-started/odd-agents-and-mcp.md"},{"type":"artifact","ref":"/Users/chrisklapp/klappy.dev/canon/agents/odd-epistemic-guide.md"}],"links":["klappy://canon/agents/odd-epistemic-guide","klappy://canon/agents/odd-scribe"],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260129-0003","timestamp":"2026-01-29T14:40:00Z","title":"Learnings and Decisions are first-class documentation citizens","status":"accepted","decision":"Learnings and Decisions are captured in append-only JSONL ledgers as first-class documentation, with a promotion ladder to canon","context":"Valuable insights were evaporating between sessions. Decisions were being relitigated because rationale was not preserved. We needed a low-ceremony capture mechanism that could escalate to durable canon.","options_considered":[{"option":"Ad-hoc notes in various places","pros":["No ceremony","Flexible"],"cons":["Things get lost","No structure for retrieval","Repeated re-teaching"]},{"option":"Everything goes straight to canon","pros":["Permanent","Authoritative"],"cons":["Too much friction for quick captures","Canon becomes cluttered","Premature formalization"]},{"option":"Ledger-first with promotion ladder (chosen)","pros":["Low ceremony capture","Structured for retrieval","Selective promotion keeps canon clean","Append-only is merge-friendly"],"cons":["Two-tier system to understand","Requires Scribe agent role"]}],"rationale":["Captures value without blocking flow","Promotion is selective and human-controlled","JSONL is automation-ready","Separates 'remembering' from 'formalizing'"],"consequences":["odd/ledger/learnings.jsonl and decisions.jsonl exist in projects","Scribe agent role records entries","Promotion to canon requires human review","Decision records become citable via klappy:// URIs"],"evidence":[{"type":"artifact","ref":"/Users/chrisklapp/klappy.dev/canon/agents/odd-scribe.md"},{"type":"artifact","ref":"/Users/chrisklapp/klappy.dev/canon/decisions/decision-record-standard.md"}],"links":["klappy://canon/agents/odd-scribe","klappy://canon/decisions/decision-record-standard"],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260129-0004","timestamp":"2026-01-29T18:21:52Z","title":"Preserve git history; prefer new commits over rewriting","status":"accepted","decision":"When offered the option to amend a commit, always create a new commit instead. Do not rewrite git history. We need to learn from mistakes, not hide them.","context":"User was offered the option to amend a previous commit to include new evidence. They explicitly declined and stated their principle: no, create a new commit, I cannot stand rewritten history, we need to learn from mistakes, not hide them.","options_considered":[{"option":"Amend/rewrite commits","pros":["Cleaner history","Single commit per logical change"],"cons":["Hides mistakes and learning process","Rewrites history","Prevents learning from errors","Violates epistemic principle of preserving evidence"]},{"option":"Create new commits (chosen)","pros":["Preserves full history","Enables learning from mistakes","Shows actual development process","Maintains epistemic integrity"],"cons":["May result in messier history","More commits to review"]}],"rationale":["Epistemic principle: we learn from mistakes, not by hiding them","Preserving history maintains evidence of the actual development process","Rewritten history obscures the learning journey","Append-only approach aligns with ledger philosophy"],"consequences":["Git history reflects actual development process","Mistakes and corrections are visible and learnable","No git history rewriting (amend, rebase, etc.)","May require more careful commit hygiene upfront"],"evidence":[{"type":"artifact","ref":"session-conversation-2026-01-29"}],"links":[],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260130-0001","timestamp":"2026-01-30T01:30:00Z","title":"Agent role boundaries over posture doctrine","status":"accepted","decision":"Define explicit agent role boundaries (Map Navigator, Mode Selector, Instruction Sync, Implementation Guide) instead of inventing a posture taxonomy. Agents navigate the existing map; they do not create new epistemic concepts.","context":"During implementation of instruction registry and sync, we identified a gap: agents were stepping on each other's responsibilities. Initial framing proposed a 'posture detector' to classify system state. On reflection, this was inventing unnecessary doctrine.","options_considered":[{"option":"Posture/Mode classifier (Proposal A)","pros":["Single decision point","Explicit state machine"],"cons":["Invents new taxonomy not in canon","Posture is not an ODD concept","Adds complexity without grounding"]},{"option":"Agent role boundaries (chosen)","pros":["Uses existing epistemic modes","No new doctrine invented","Clear separation of concerns","Each agent has single responsibility"],"cons":["More agents to maintain","Requires coordination"]}],"rationale":["Epistemic modes already exist in canon","Mode selector routes to MCP actions, not posture states","Map navigator embodies progressive reading without new principles","Role separation prevents overlap and drift"],"consequences":["4 new agents: odd-map-navigator, odd-mode-selector, odd-instruction-sync, odd-implementation-guide","Each agent has explicit output contract","Shared Canon Alignment block prevents drift","No posture doctrine added to canon"],"evidence":[{"type":"artifact","ref":"klappy://canon/agents/odd-map-navigator"},{"type":"artifact","ref":"klappy://canon/agents/odd-mode-selector"},{"type":"artifact","ref":"klappy://canon/agents/odd-instruction-sync"},{"type":"artifact","ref":"klappy://canon/agents/odd-implementation-guide"}],"links":["klappy://canon/epistemic-modes","klappy://canon/agents/odd-map-navigator","klappy://canon/agents/odd-mode-selector","klappy://canon/agents/odd-instruction-sync","klappy://canon/agents/odd-implementation-guide"],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260130-0002","timestamp":"2026-01-30T01:35:00Z","title":"Manual agent install as default with opt-in convenience command","status":"accepted","decision":"Keep manual file copying as the authority gate for agent installation. Add oddkit sync-agents as human-triggered convenience that shows a deterministic patch plan and requires explicit --apply to write files.","context":"After adding 4 new agents to canon, we needed a way to sync them to ~/.cursor/agents/. Options ranged from fully manual to fully automatic. ODD premise requires no silent mutation of operational truth.","options_considered":[{"option":"Fully manual (copy files)","pros":["Maximum human control","No automation risk"],"cons":["Friction for users","Easy to forget or make mistakes"]},{"option":"Auto-sync on oddkit calls","pros":["Always fresh","Zero friction"],"cons":["Violates ODD premise","Silent mutation","No human gate"]},{"option":"Human-triggered installer with dry-run (chosen)","pros":["Preserves authority gate","Removes copy-paste tax","Deterministic patch plan","Backup by default"],"cons":["Requires running a command","Still involves human action"]}],"rationale":["ODD premise: no silent mutation of operational truth","Dry-run default ensures human sees what will change","--apply flag is explicit consent","Backups preserve rollback path"],"consequences":["oddkit sync-agents shows patch plan by default","--apply required to actually copy","--backup creates timestamped backups","--only allows subset selection"],"evidence":[{"type":"artifact","ref":"oddkit/src/tasks/syncAgents.js"},{"type":"test","ref":"oddkit/tests/sync-agents.test.sh"}],"links":["oddkit://docs/oddkit/CHARTER"],"supersedes":[],"superseded_by":null,"candidate_promotion":"none"}
{"id":"dec-20260130-0003","timestamp":"2026-01-30T01:42:00Z","title":"ODDKIT COMPASS as fallback plus invariants, not primary steering","status":"accepted","decision":"Reframe the Cursor rule ODDKIT COMPASS from always-on primary steering to fallback plus invariants. Use when no agent is active or when an agent response lacks proof. Agents (mode-selector, map-navigator, implementation-guide, instruction-sync) handle primary workflow; Compass is the cross-cutting safety net.","context":"With agent role docs now in place, the Compass rule was the only steering wheel before. Now it duplicated and could conflict with agent instructions. We needed to downgrade it from primary to safety net without losing the two failure modes agents do not prevent: unjustified certainty and answering from memory about canon.","options_considered":[{"option":"Remove Compass","pros":["Single source of truth in agents"],"cons":["No guardrail when agent not installed or off-script","Quick interactions have no safety"]},{"option":"Keep Compass as always-on primary","pros":["Familiar","Strong steering"],"cons":["Conflicts with agent roles","Redundant when agents active"]},{"option":"Compass as fallback plus invariants (chosen)","pros":["Covers gap when no agent or agent fails","Policy uncertainty: Map Navigator first then oddkit","Completion claims: validate and artifacts","No pre-injecting docs"],"cons":["Two layers to understand"]}],"rationale":["Cursor rules apply to all agents and humans; agents do not","New agent doc not yet installed, agent off-script, or quick interaction without role invocation still need a contract","Compass invariants are the two failure modes: unjustified done/shipped and answering canon from memory"],"consequences":[".cursor/rules/oddkit-compass.mdc frames Compass as fallback","Policy flow: Map Navigator small to medium to large then oddkit_orchestrate","Completion: validate plus artifacts or ask for cheapest artifact","Conflicts and drift: advisory plus minimal evidence"],"evidence":[{"type":"artifact","ref":"oddkit/.cursor/rules/oddkit-compass.mdc"}],"links":["oddkit://docs/MCP.md","klappy://canon/agents/odd-map-navigator","klappy://canon/agents/odd-mode-selector"],"supersedes":[],"superseded_by":null,"candidate_promotion":"canon-decision-record"}
{"id":"dec-20260205-0001","timestamp":"2026-02-05T12:06:00Z","title":"Use CDN libraries over hand-rolled parsers in template literals","status":"accepted","decision":"Always use established CDN libraries (marked, DOMPurify, etc.) for complex parsing tasks in HTML template literals served from Cloudflare Workers. Never hand-roll regex-based parsers inside template literals.","context":"Two consecutive fatal bugs in the chat UI were caused by JavaScript regex patterns inside TypeScript template literals. Backslash escaping rules differ between template literals and regular strings, causing silent corruption of regex patterns. The hand-rolled markdown parser was unfixable without switching to a library.","options_considered":[{"option":"Fix escaping in hand-rolled parser","pros":["No external dependency","Full control"],"cons":["Fragile—every new regex risks the same bug","Template literal escaping is a minefield","Hard to test embedded JS in template strings"]},{"option":"CDN libraries: marked + DOMPurify (chosen)","pros":["Battle-tested","No escaping issues","Better markdown support","Built-in XSS protection","Maintained by community"],"cons":["External dependency","CDN availability risk","Larger page load"]}],"rationale":["Two fatal bugs in two days from regex escaping","Template literals silently eat single backslashes","Libraries eliminate entire class of bugs","DOMPurify provides XSS protection for free"],"consequences":["Chat UI loads marked@15 and DOMPurify@3 from jsdelivr CDN","No regex patterns for parsing in template literal HTML","Custom link renderer restricts URLs to http/https only","All HTML output sanitized through DOMPurify"],"evidence":[{"type":"commit","ref":"e52ba0f - Replace hand-rolled markdown with marked + DOMPurify from CDN"},{"type":"commit","ref":"40e06a9 - Fix fatal JS parse error"},{"type":"commit","ref":"f49f757 - Fix bold/italic regex escaping"}],"links":[],"supersedes":[],"superseded_by":null,"candidate_promotion":"none"}
{"id":"dec-20260205-0002","timestamp":"2026-02-05T12:07:00Z","title":"Cloudflare secrets via dashboard, not wrangler.toml or deploy scripts","status":"accepted","decision":"Store sensitive API keys (OPENAI_API_KEY) via Cloudflare dashboard (Workers > Settings > Variables and Secrets > Encrypt). Do not use wrangler.toml vars, --var in deploy scripts, or wrangler secret put for keys that must persist across deploys in cloud environments.","context":"OPENAI_API_KEY was being wiped on every deploy. Multiple approaches failed: wrangler secret put (wiped by deploy), --var in deploy script (requires local env vars unavailable in cloud). The user is in a cloud CI environment (Claude Code on web) with no access to persistent local env vars or ability to commit secrets to a public repo.","options_considered":[{"option":"wrangler secret put","pros":["Simple CLI command"],"cons":["Can be wiped by deploys","Requires re-running after each deploy"]},{"option":"--var in deploy script from env","pros":["Automated","No dashboard needed"],"cons":["Requires local env var","Unavailable in cloud environments","Cannot commit to public repo"]},{"option":"Cloudflare dashboard encrypt (chosen)","pros":["Persists across all deploys","Works from any environment","No secrets in code or env"],"cons":["Manual dashboard step","Not automatable from CLI"]}],"rationale":["User is in cloud environment without persistent local env vars","Public repo cannot contain secrets","Dashboard secrets persist regardless of deploy method","One-time setup, not per-deploy"],"consequences":["OPENAI_API_KEY set via Cloudflare dashboard only","wrangler.toml contains comment documenting the dashboard path","Deploy scripts do not reference OPENAI_API_KEY","No .env or env var dependency for secrets"],"evidence":[{"type":"commit","ref":"64c8e26 - Revert --var OPENAI_API_KEY from deploy, use dashboard secret"},{"type":"artifact","ref":"workers/wrangler.toml - line 14"}],"links":[],"supersedes":[],"superseded_by":null,"candidate_promotion":"none"}
